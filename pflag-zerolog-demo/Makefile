APP_NAME := viper-env-demo
VERSION := v1.0.0
BUILD_DIR := ./bin

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN := \033[32m
YELLOW := \033[33m
CYAN := \033[36m
RED := \033[31m
NC := \033[0m

.PHONY: help build clean demo test-env test-config test-priority examples

# –ü–æ–º–æ—â—å
help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
	@echo "$(CYAN)$(APP_NAME) - Viper + Environment Variables Demo$(NC)"
	@echo ""
	@echo "$(YELLOW)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##/ {printf "  $(GREEN)%-20s$(NC) %s\n", $1, $2}' $(MAKEFILE_LIST)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
deps: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@echo "$(YELLOW)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	go mod download
	go mod tidy

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
build: deps ## –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	@echo "$(YELLOW)–°–±–æ—Ä–∫–∞ $(APP_NAME)...$(NC)"
	@mkdir -p $(BUILD_DIR)
	go build -ldflags "-X main.appVersion=$(VERSION)" -o $(BUILD_DIR)/$(APP_NAME) .
	@echo "$(GREEN)‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(BUILD_DIR)/$(APP_NAME)$(NC)"

# –û—á–∏—Å—Ç–∫–∞
clean: ## –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏
	@echo "$(YELLOW)–û—á–∏—Å—Ç–∫–∞...$(NC)"
	rm -rf $(BUILD_DIR)
	go clean -cache

# –û—Å–Ω–æ–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
demo: build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
	@echo "$(CYAN)üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è Viper + Environment Variables$(NC)"
	@echo ""
	@$(BUILD_DIR)/$(APP_NAME)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
test-env: build ## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
	@echo "$(CYAN)üåç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è$(NC)"
	@echo ""
	@echo "$(YELLOW)1. –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö):$(NC)"
	@$(BUILD_DIR)/$(APP_NAME) --show-config
	@echo ""
	@echo "$(YELLOW)2. –° –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:$(NC)"
	@VIPER_LOG_LEVEL=debug \
	 VIPER_SERVER_PORT=3000 \
	 VIPER_APP_ENVIRONMENT=staging \
	 $(BUILD_DIR)/$(APP_NAME) --show-config
	@echo ""
	@echo "$(YELLOW)3. –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:$(NC)"
	@VIPER_LOG_LEVEL=trace \
	 VIPER_SERVER_HOST=0.0.0.0 \
	 VIPER_DATABASE_PASSWORD=secret123 \
	 $(BUILD_DIR)/$(APP_NAME) --show-env

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
test-config: build ## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
	@echo "$(CYAN)üìã –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞$(NC)"
	@echo ""
	@echo "$(YELLOW)1. –° –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º:$(NC)"
	@$(BUILD_DIR)/$(APP_NAME) --config=config.yaml --show-config
	@echo ""
	@echo "$(YELLOW)2. –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞–º–∏:$(NC)"
	@$(BUILD_DIR)/$(APP_NAME) --config=config.yaml --log-level=trace --debug --show-config

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
test-priority: build ## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
	@echo "$(CYAN)üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫$(NC)"
	@echo ""
	@echo "$(YELLOW)1. –¢–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:$(NC)"
	@$(BUILD_DIR)/$(APP_NAME)
	@echo ""
	@echo "$(YELLOW)2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:$(NC)"
	@VIPER_LOG_LEVEL=debug \
	 VIPER_SERVER_PORT=4000 \
	 $(BUILD_DIR)/$(APP_NAME)
	@echo ""
	@echo "$(YELLOW)3. –§–ª–∞–≥–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:$(NC)"
	@VIPER_LOG_LEVEL=debug \
	 VIPER_SERVER_PORT=4000 \
	 $(BUILD_DIR)/$(APP_NAME) --log-level=trace --verbose

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
examples: build ## –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
	@echo "$(CYAN)üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Viper —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è$(NC)"
	@echo ""
	@echo "$(YELLOW)–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@echo "  $(BUILD_DIR)/$(APP_NAME)                    # –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
	@echo "  $(BUILD_DIR)/$(APP_NAME) --show-config      # –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
	@echo "  $(BUILD_DIR)/$(APP_NAME) --show-env         # –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
	@echo "  $(BUILD_DIR)/$(APP_NAME) --help             # –°–ø—Ä–∞–≤–∫–∞"
	@echo ""
	@echo "$(YELLOW)–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:$(NC)"
	@echo "  VIPER_LOG_LEVEL=debug $(BUILD_DIR)/$(APP_NAME)"
	@echo "  VIPER_SERVER_PORT=3000 $(BUILD_DIR)/$(APP_NAME)"
	@echo "  VIPER_APP_ENVIRONMENT=production $(BUILD_DIR)/$(APP_NAME)"
	@echo ""
	@echo "$(YELLOW)–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:$(NC)"
	@echo "  VIPER_LOG_LEVEL=debug VIPER_SERVER_PORT=8080 $(BUILD_DIR)/$(APP_NAME) --verbose"
	@echo "  $(BUILD_DIR)/$(APP_NAME) --config=config.yaml --log-level=trace"
	@echo ""
	@echo "$(YELLOW)–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É):$(NC)"
	@echo "  1. –§–ª–∞–≥–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏"
	@echo "  2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–µ—Ñ–∏–∫—Å VIPER_)"
	@echo "  3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª"
	@echo "  4. –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"

# –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
create-env: ## –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –∏–∑ .env.example
	@echo "$(YELLOW)–°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞...$(NC)"
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "$(GREEN)‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏–∑ .env.example$(NC)"; \
		echo "$(YELLOW)–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã$(NC)"; \
	else \
		echo "$(RED)‚ùå .env —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç$(NC)"; \
	fi

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
run-with-env: build create-env ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ .env —Ñ–∞–π–ª–∞
	@echo "$(CYAN)üåç –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–∑ .env —Ñ–∞–π–ª–∞$(NC)"
	@echo ""
	@if [ -f .env ]; then \
		set -a && source .env && set +a && $(BUILD_DIR)/$(APP_NAME); \
	else \
		echo "$(RED)‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'make create-env' —Å–Ω–∞—á–∞–ª–∞.$(NC)"; \
	fi

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
demo-all: build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
	@echo "$(CYAN)üéØ –ü–æ–ª–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è Viper + Environment Variables$(NC)"
	@echo ""
	@make test-env
	@echo ""
	@make test-config
	@echo ""
	@make test-priority

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
interactive: build ## –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
	@echo "$(CYAN)üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è$(NC)"
	@echo ""
	@echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@make examples
	@echo ""
	@echo "–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'make demo-all' –¥–ª—è –ø–æ–ª–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"
