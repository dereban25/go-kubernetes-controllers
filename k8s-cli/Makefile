# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
APP_NAME := k8s-cli
VERSION := v1.0.0
BUILD_DIR := ./bin
GO_VERSION := 1.21

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN := \033[32m
YELLOW := \033[33m
CYAN := \033[36m
NC := \033[0m

.PHONY: help build install clean test run deps examples

# –ü–æ–º–æ—â—å
help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
	@echo "$(CYAN)$(APP_NAME) - Kubernetes CLI Tool$(NC)"
	@echo ""
	@echo "$(YELLOW)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##/ {printf "  $(GREEN)%-15s$(NC) %s\n", $1, $2}' $(MAKEFILE_LIST)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
deps: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@echo "$(YELLOW)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	go mod download
	go mod tidy

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
build: deps ## –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	@echo "$(YELLOW)–°–±–æ—Ä–∫–∞ $(APP_NAME)...$(NC)"
	@mkdir -p $(BUILD_DIR)
	go build -ldflags "-X main.version=$(VERSION)" -o $(BUILD_DIR)/$(APP_NAME) .
	@echo "$(GREEN)‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(BUILD_DIR)/$(APP_NAME)$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º—É
install: build ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É
	@echo "$(YELLOW)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ $(APP_NAME)...$(NC)"
	sudo cp $(BUILD_DIR)/$(APP_NAME) /usr/local/bin/
	@echo "$(GREEN)‚úÖ $(APP_NAME) —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ /usr/local/bin/$(NC)"

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
run: build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
	@echo "$(YELLOW)–ó–∞–ø—É—Å–∫ $(APP_NAME)...$(NC)"
	$(BUILD_DIR)/$(APP_NAME)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
	@echo "$(YELLOW)–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...$(NC)"
	go test -v ./...

# –û—á–∏—Å—Ç–∫–∞
clean: ## –û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–±–æ—Ä–∫–∏
	@echo "$(YELLOW)–û—á–∏—Å—Ç–∫–∞...$(NC)"
	rm -rf $(BUILD_DIR)
	go clean -cache

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
check-env: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ
	@echo "$(YELLOW)–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(NC)"
	@which kubectl > /dev/null || (echo "‚ùå kubectl –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)
	@kubectl cluster-info > /dev/null || (echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É Kubernetes" && exit 1)
	@echo "$(GREEN)‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ$(NC)"

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
fmt: ## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
	@echo "$(YELLOW)–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞...$(NC)"
	go fmt ./...
	@echo "$(GREEN)‚úÖ –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω$(NC)"

# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
demo: build check-env ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é
	@echo "$(CYAN)üöÄ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è k8s-cli$(NC)"
	@echo ""
	@echo "$(YELLOW)1. –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:$(NC)"
	$(BUILD_DIR)/$(APP_NAME) context current
	@echo ""
	@echo "$(YELLOW)2. –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤:$(NC)"
	$(BUILD_DIR)/$(APP_NAME) context list
	@echo ""
	@echo "$(YELLOW)3. –°–ø–∏—Å–æ–∫ –ø–æ–¥–æ–≤:$(NC)"
	$(BUILD_DIR)/$(APP_NAME) list pods
	@echo ""
	@echo "$(YELLOW)4. –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤:$(NC)"
	$(BUILD_DIR)/$(APP_NAME) list services
