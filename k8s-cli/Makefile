# Makefile for k8s-cli with Step 7-12 support

# Variables
BINARY_NAME=k8s-cli
VERSION ?= dev
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
COMMIT_SHA := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# Build flags
LDFLAGS := -ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME) -X main.commitSHA=$(COMMIT_SHA)"

# Colors for output
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
BLUE := \033[0;34m
NC := \033[0m # No Color

# Go related variables
GOBASE := $(shell pwd)
GOPATH := $(GOBASE)/vendor:$(GOBASE)
GOBIN := $(GOBASE)/bin
GOFILES := $(wildcard *.go)

# Controller-gen
CONTROLLER_GEN = $(shell pwd)/bin/controller-gen
CONTROLLER_TOOLS_VERSION ?= v0.13.0

# Default target
.PHONY: all
all: clean deps generate manifests build

# Install controller-gen if necessary
.PHONY: controller-gen
controller-gen:
	@if [ ! -f $(CONTROLLER_GEN) ]; then \
		echo "$(YELLOW)üì¶ Installing controller-gen...$(NC)"; \
		GOBIN=$(shell pwd)/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@$(CONTROLLER_TOOLS_VERSION); \
	fi

# Generate DeepCopy methods
.PHONY: generate
generate: controller-gen
	@echo "$(GREEN)üîß Generating DeepCopy methods...$(NC)"
	$(CONTROLLER_GEN) object:headerFile="hack/boilerplate.go.txt" paths="./api/..."
	@echo "$(GREEN)‚úÖ Code generation completed$(NC)"

# Generate CRD manifests
.PHONY: manifests
manifests: controller-gen
	@echo "$(GREEN)üìÑ Generating CRD manifests...$(NC)"
	$(CONTROLLER_GEN) crd paths="./api/..." output:crd:artifacts:config=config/crd/bases
	@echo "$(GREEN)‚úÖ CRD manifests generated$(NC)"

# Install CRDs into cluster
.PHONY: install-crds
install-crds: manifests
	@echo "$(GREEN)üì¶ Installing CRDs to cluster...$(NC)"
	kubectl apply -f config/crd/bases/
	@echo "$(GREEN)‚úÖ CRDs installed$(NC)"

# Uninstall CRDs from cluster
.PHONY: uninstall-crds
uninstall-crds:
	@echo "$(YELLOW)üóëÔ∏è Removing CRDs from cluster...$(NC)"
	kubectl delete -f config/crd/bases/ --ignore-not-found=true
	@echo "$(GREEN)‚úÖ CRDs removed$(NC)"

# Build the binary
.PHONY: build
build:
	@echo "$(GREEN)üî® Building $(BINARY_NAME)...$(NC)"
	mkdir -p bin
	go build $(LDFLAGS) -o bin/$(BINARY_NAME) main.go
	@echo "$(GREEN)‚úÖ Build completed: bin/$(BINARY_NAME)$(NC)"

# Install dependencies
.PHONY: deps
deps:
	@echo "$(GREEN)üì¶ Installing dependencies...$(NC)"
	go mod download
	go mod tidy
	@echo "$(GREEN)‚úÖ Dependencies installed$(NC)"

# Clean build artifacts
.PHONY: clean
clean:
	@echo "$(YELLOW)üßπ Cleaning...$(NC)"
	go clean
	rm -rf bin/
	rm -rf vendor/
	rm -f test-*.yaml
	rm -f zz_generated.deepcopy.go
	@echo "$(GREEN)‚úÖ Clean completed$(NC)"

# Run tests
.PHONY: test
test:
	@echo "$(BLUE)üß™ Running unit tests...$(NC)"
	go test -v ./tests/...

# Format code
.PHONY: fmt
fmt:
	@echo "$(GREEN)üé® Formatting code...$(NC)"
	go fmt ./...
	@echo "$(GREEN)‚úÖ Code formatted$(NC)"

# Lint code
.PHONY: lint
lint:
	@echo "$(GREEN)üîç Running linter...$(NC)"
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run; \
		echo "$(GREEN)‚úÖ Linting completed$(NC)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è golangci-lint not found, skipping lint check$(NC)"; \
		echo "$(YELLOW)üí° To install: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest$(NC)"; \
	fi

# Build and run basic tests
.PHONY: test-build
test-build: build
	@echo "$(BLUE)üìã Testing build and basic commands...$(NC)"
	@./bin/$(BINARY_NAME) --help > /dev/null && echo "$(GREEN)‚úÖ Help command works$(NC)" || echo "$(RED)‚ùå Help command failed$(NC)"
	@./bin/$(BINARY_NAME) version > /dev/null && echo "$(GREEN)‚úÖ Version command works$(NC)" || echo "$(RED)‚ùå Version command failed$(NC)"

# Run checks (similar to CI)
.PHONY: check
check: fmt lint test build
	@echo "$(GREEN)‚úÖ All checks passed!$(NC)"

# Install to system
.PHONY: install
install: build
	@echo "$(GREEN)üì¶ Installing to system...$(NC)"
	@if [ -w /usr/local/bin ]; then \
		cp bin/$(BINARY_NAME) /usr/local/bin/; \
		echo "$(GREEN)‚úÖ Installed to /usr/local/bin/$(BINARY_NAME)$(NC)"; \
	else \
		sudo cp bin/$(BINARY_NAME) /usr/local/bin/; \
		echo "$(GREEN)‚úÖ Installed to /usr/local/bin/$(BINARY_NAME) (with sudo)$(NC)"; \
	fi

# Uninstall from system
.PHONY: uninstall
uninstall:
	@echo "$(YELLOW)üóëÔ∏è Uninstalling from system...$(NC)"
	@if [ -w /usr/local/bin ]; then \
		rm -f /usr/local/bin/$(BINARY_NAME); \
	else \
		sudo rm -f /usr/local/bin/$(BINARY_NAME); \
	fi
	@echo "$(GREEN)‚úÖ Uninstalled$(NC)"

# Quick build for development
.PHONY: quick
quick:
	@echo "$(GREEN)‚ö° Quick build...$(NC)"
	go build -o bin/$(BINARY_NAME) main.go

# Build for multiple platforms
.PHONY: build-all
build-all:
	@echo "$(GREEN)üåç Building for multiple platforms...$(NC)"
	GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o bin/$(BINARY_NAME)-linux-amd64 main.go
	GOOS=darwin GOARCH=amd64 go build $(LDFLAGS) -o bin/$(BINARY_NAME)-darwin-amd64 main.go
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o bin/$(BINARY_NAME)-windows-amd64.exe main.go
	@echo "$(GREEN)‚úÖ Multi-platform build completed$(NC)"

# Step-specific test targets
.PHONY: test-step7
test-step7: build
	@echo "$(BLUE)üîÑ Testing Step 7: Informers...$(NC)"
	@timeout 10s ./bin/$(BINARY_NAME) watch-informer --workers 1 --resync-period 5s || true
	@echo "$(GREEN)‚úÖ Step 7 test completed$(NC)"

.PHONY: test-step7plus
test-step7plus: build
	@echo "$(BLUE)üåê Testing Step 7+: JSON API...$(NC)"
	@./bin/$(BINARY_NAME) api-server --port 8080 > /tmp/api-test.log 2>&1 & \
	API_PID=$$!; \
	sleep 3; \
	curl -s http://localhost:8080/api/v1/health || true; \
	kill $$API_PID 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Step 7+ test completed$(NC)"

.PHONY: test-step8
test-step8: build
	@echo "$(BLUE)üöÄ Testing Step 8: Advanced API...$(NC)"
	@./bin/$(BINARY_NAME) step8-api --port 8090 > /tmp/step8-test.log 2>&1 & \
	API_PID=$$!; \
	sleep 3; \
	curl -s http://localhost:8090/api/v2/health || true; \
	kill $$API_PID 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Step 8 test completed$(NC)"

.PHONY: test-step9
test-step9: build
	@echo "$(BLUE)üéÆ Testing Step 9: Controller Runtime...$(NC)"
	@timeout 10s ./bin/$(BINARY_NAME) controller --workers 1 || true
	@echo "$(GREEN)‚úÖ Step 9 test completed$(NC)"

.PHONY: test-step10
test-step10: build
	@echo "$(BLUE)üëë Testing Step 10: Manager...$(NC)"
	@timeout 10s ./bin/$(BINARY_NAME) manager --enable-leader-election=false || true
	@echo "$(GREEN)‚úÖ Step 10 test completed$(NC)"

.PHONY: test-step11
test-step11: build generate manifests
	@echo "$(BLUE)üîß Testing Step 11: CRD Controller...$(NC)"
	@timeout 10s ./bin/$(BINARY_NAME) crd --enable-leader-election=false || true
	@echo "$(GREEN)‚úÖ Step 11 test completed$(NC)"

.PHONY: test-step12
test-step12: build
	@echo "$(BLUE)üèóÔ∏è Testing Step 12: Platform API...$(NC)"
	@./bin/$(BINARY_NAME) platform --port 8084 > /tmp/platform-test.log 2>&1 & \
	API_PID=$$!; \
	sleep 3; \
	curl -s http://localhost:8084/health || true; \
	kill $$API_PID 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Step 12 test completed$(NC)"

# Test all steps
.PHONY: test-all-steps
test-all-steps: test-step7 test-step7plus test-step8 test-step9 test-step10 test-step11 test-step12
	@echo "$(GREEN)üéâ All step tests completed!$(NC)"

# Complete test suite
.PHONY: test-complete
test-complete: check test-all-steps
	@echo ""
	@echo "$(GREEN)üéØ COMPLETE TEST SUITE FINISHED!$(NC)"
	@echo ""
	@echo "$(BLUE)üìä Summary:$(NC)"
	@echo "   ‚úÖ Build and basic commands"
	@echo "   ‚úÖ Code formatting and linting"
	@echo "   ‚úÖ Unit tests"
	@echo "   ‚úÖ Step 7: Informers"
	@echo "   ‚úÖ Step 7+: JSON API"
	@echo "   ‚úÖ Step 8: Advanced API"
	@echo "   ‚úÖ Step 9: Controller Runtime"
	@echo "   ‚úÖ Step 10: Manager"
	@echo "   ‚úÖ Step 11: CRD Controller"
	@echo "   ‚úÖ Step 12: Platform API"
	@echo ""
	@echo "$(GREEN)üéâ Your k8s-cli is ready with Steps 7-12++ support!$(NC)"

# Run integration tests
.PHONY: integration
integration: build
	@echo "$(BLUE)üß™ Running integration tests...$(NC)"
	go test -v ./tests/... -tags=integration

# Demo scenarios
.PHONY: demo
demo: build
	@echo "$(BLUE)üé¨ Running demo scenario...$(NC)"
	./bin/$(BINARY_NAME) context current
	./bin/$(BINARY_NAME) list deployments
	@echo "$(GREEN)‚úÖ Demo completed$(NC)"

.PHONY: demo-frontendpage
demo-frontendpage: build
	@echo "$(BLUE)üé¨ Creating demo FrontendPage resources...$(NC)"
	kubectl apply -f examples/frontendpage-demo.yaml || true
	@sleep 2
	kubectl get frontendpages || true
	@echo "$(GREEN)‚úÖ FrontendPage demo completed$(NC)"

.PHONY: demo-platform
demo-platform: build
	@echo "$(BLUE)üé¨ Testing platform actions...$(NC)"
	@curl -X GET http://localhost:8084/api/v1/actions 2>/dev/null || echo "Platform API not running"
	@echo "$(GREEN)‚úÖ Platform demo completed$(NC)"

# Development helpers
.PHONY: dev-watch
dev-watch: build
	@echo "$(BLUE)üîÑ Starting development watch mode...$(NC)"
	./bin/$(BINARY_NAME) watch-informer --workers 2 --resync-period 10s --log-events

.PHONY: dev-api
dev-api: build
	@echo "$(BLUE)üåê Starting development API server...$(NC)"
	./bin/$(BINARY_NAME) api-server --port 8080

.PHONY: dev-step8
dev-step8: build
	@echo "$(BLUE)üöÄ Starting development Step 8 API server...$(NC)"
	./bin/$(BINARY_NAME) step8-api --port 8090 --enable-debug --enable-metrics

.PHONY: dev-controller
dev-controller: build
	@echo "$(BLUE)üéÆ Starting development controller...$(NC)"
	./bin/$(BINARY_NAME) controller --workers 2

.PHONY: dev-manager
dev-manager: build
	@echo "$(BLUE)üëë Starting development manager...$(NC)"
	./bin/$(BINARY_NAME) manager --enable-leader-election=false

.PHONY: dev-crd
dev-crd: build generate manifests install-crds
	@echo "$(BLUE)üîß Starting development CRD controller...$(NC)"
	./bin/$(BINARY_NAME) crd --enable-leader-election=false

.PHONY: dev-platform
dev-platform: build
	@echo "$(BLUE)üèóÔ∏è Starting development platform API...$(NC)"
	./bin/$(BINARY_NAME) platform --port 8084

# Help
.PHONY: help
help:
	@echo "$(BLUE)k8s-cli Makefile - Step 7-12++ Support$(NC)"
	@echo ""
	@echo "$(YELLOW)Main targets:$(NC)"
	@echo "  all              - Clean, generate, and build everything"
	@echo "  build            - Build the binary"
	@echo "  clean            - Clean build artifacts"
	@echo "  deps             - Install dependencies"
	@echo "  generate         - Generate DeepCopy methods"
	@echo "  manifests        - Generate CRD manifests"
	@echo "  install-crds     - Install CRDs to cluster"
	@echo ""
	@echo "$(YELLOW)Test targets:$(NC)"
	@echo "  test             - Run unit tests"
	@echo "  test-complete    - Complete test suite"
	@echo "  test-all-steps   - Test all Step 7-12 functionality"
	@echo "  check            - Run all checks (fmt, lint, test, build)"
	@echo ""
	@echo "$(YELLOW)Development:$(NC)"
	@echo "  dev-*            - Start development servers for each component"
	@echo "  demo             - Run demo scenarios"
	@echo ""
	@echo "$(YELLOW)Installation:$(NC)"
	@echo "  install          - Install to /usr/local/bin"
	@echo "  uninstall        - Remove from system"
	@echo ""
	@echo "$(YELLOW)Examples:$(NC)"
	@echo "  make                      # Build everything"
	@echo "  make test-complete        # Full test suite"
	@echo "  make dev-crd              # Start CRD controller development"